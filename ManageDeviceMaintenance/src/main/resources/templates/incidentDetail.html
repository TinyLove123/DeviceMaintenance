<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Trang chi tiết báo cáo</title>
    <th:block th:replace="base :: bootstrap"></th:block>
</head>
<body>
    <div th:replace="base :: header"></div>

    <main class="container mt-4">
        <h1 class="mb-4">Chi tiết Báo cáo & Thiết bị</h1>

        <div class="row">
            <!-- KHUNG SỰ CỐ -->
            <div class="col-md-6">
                <div class="card mb-4 shadow">
                    <div class="card-header bg-danger text-white">
                        <h5>Sự cố</h5>
                    </div>
                    <div class="card-body" th:if="${Incident != null}">
                        <h5 th:text="${Incident.title}"></h5>
                        <p><strong>Mô tả chi tiết:</strong> <span th:text="${Incident.detailDescribe}"></span></p>
                        <p><strong>Người gửi:</strong> <span th:text="${Incident.senderId.firstName + ' ' + Incident.senderId.lastName}"></span></p>
                        <p><strong>Ngày báo cáo:</strong> 
                            <span th:text="${Incident.reportDate != null ? #dates.format(Incident.reportDate, 'dd/MM/yyyy HH:mm:ss') : 'Chưa có'}"></span>
                        </p>
                        <p><strong>Trạng thái:</strong> <span th:text="${Incident.status}"></span></p>

                        <div class="card mb-4 shadow" th:if="${Incident.status != 'PENDING_APPROVAL' and Incident.status != 'REJECTED'}">
                            <label class="col-sm-5 col-form-label"><strong>Trạng thái thực hiện:</strong></label>
                            <div class="col-sm-7">
                                <span th:if="${Incident.employeeId != null and now.after(Incident.startDate) and Incident.status != 'IN_PROGRESS' and Incident.status != 'RESOLVED'}"
                                      class="text-danger fw-bold">Quá hạn bắt đầu thực hiện!</span>
                                <span th:if="${Incident.employeeId != null and now.after(Incident.endDate) and Incident.status != 'RESOLVED'}"
                                      class="text-danger fw-bold">Quá hạn kết thúc dự kiến!</span>
                                <span th:if="${Incident.employeeId != null and !(now.after(Incident.startDate) or now.after(Incident.endDate))}">
                                    Đúng tiến độ
                                </span>
                            </div>
                        </div>

                        <!-- FORM cập nhật trạng thái -->
                        <!-- FORM cập nhật trạng thái -->
                        <div th:if="${Incident.status == 'PENDING_APPROVAL'}">
                            <form th:action="@{|/admin/incident-device/${Incident.id}/incident-update|}" 
                                  method="post" 
                                  th:object="${Incident}" 
                                  onsubmit="return validateForm()">

                                <div class="mb-3">
                                    <label for="status" class="form-label">Cập nhật trạng thái:</label>
                                    <select th:field="*{status}" id="status" class="form-control"
                                            onchange="toggleEmployeeDropdown(this.value)">
                                        <option value="APPROVED">APPROVED</option>
                                        <option value="REJECTED">REJECTED</option>
                                    </select>
                                </div>

                                <input type="hidden" th:field="*{id}" />
                                <input type="hidden" th:field="*{deviceId.id}" />

                                <div id="approvedFields" style="display: none;">
                                    <div class="mb-3">
                                        <label for="employeeId" class="form-label">Nhân viên xử lý:</label>
                                        <select th:field="*{employeeId.id}" id="employeeId" class="form-control">
                                            <option value="">-- Chọn nhân viên --</option>
                                            <option th:each="emp : ${employees}" 
                                                    th:value="${emp.id}" 
                                                    th:text="${emp.firstName + ' ' + emp.lastName}">
                                            </option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="startDate" class="form-label">Ngày bắt đầu thực hiện:</label>
                                        <input type="datetime-local" th:field="*{startDate}" id="startDate" class="form-control" />
                                    </div>

                                    <div class="mb-3">
                                        <label for="endDate" class="form-label">Ngày kết thúc dự kiến:</label>
                                        <input type="datetime-local" th:field="*{endDate}" id="endDate" class="form-control" />
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary">Cập nhật</button>
                            </form>
                        </div>
                        <div th:if="${Incident.status != 'PENDING_APPROVAL'}" class="mb-3">
                            <label class="form-label"><strong>Trạng thái hiện tại:</strong></label>
                            <span class="badge bg-success" style="font-size: 1rem;" th:text="${Incident.status}"></span>
                            <div class="alert alert-info mt-3" role="alert">
                                Báo cáo đã được xử lý ở trạng thái <strong th:text="${Incident.status}"></strong>. Bạn không thể cập nhật trạng thái nữa.
                            </div>
                        </div>

                    </div>

                    <div class="card-body text-center text-muted" th:if="${Incident == null}">
                        <p>Không tìm thấy thông tin sự cố.</p>
                    </div>
                </div>
            </div>

            <!-- KHUNG THIẾT BỊ -->
            <div class="col-md-6">
                <div class="card mb-4 shadow">
                    <div class="card-header bg-primary text-white">
                        <h5>Thông tin Thiết bị</h5>
                    </div>
                    <div class="card-body" th:if="${Incident.deviceId != null}">
                        <p><strong>Tên thiết bị:</strong> <span th:text="${Incident.deviceId.nameDevice}"></span></p>
                        <p><strong>Ngày mua:</strong> 
                            <span th:text="${Incident.deviceId.purchaseDate != null ? #dates.format(Incident.deviceId.purchaseDate, 'dd/MM/yyyy') : 'Chưa có'}"></span>
                        </p>
                        <p><strong>Vị trí hiện tại:</strong>
                            <span th:text="${Incident.deviceId.currentLocationId != null ? Incident.deviceId.currentLocationId.wardId.fullName
                                  + ', ' + Incident.deviceId.currentLocationId.wardId.provinceCode.fullName 
                                  + ', ' + Incident.deviceId.currentLocationId.address : 'Chưa cập nhật'}"></span>
                        </p>
                        <p><strong>Loại thiết bị:</strong> <span th:text="${Incident.deviceId.categoryId.type}"></span></p>
                    </div>
                </div>
            </div>

            <!-- THÔNG TIN XỬ LÝ (nếu APPROVED) -->
            <div class="col-md-12" th:if="${Incident.status != 'PENDING_APPROVAL' and Incident.status != 'REJECTED'}">
                <div class="card mb-4 shadow">
                    <div class="card-header bg-success text-white">
                        <h5>Thông tin xử lý</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3 row">
                            <label class="col-sm-5 col-form-label"><strong>Nhân viên xử lý:</strong></label>
                            <div class="col-sm-7">
                                <span th:text="${Incident.employeeId != null ? Incident.employeeId.firstName + ' ' + Incident.employeeId.lastName : 'Chưa phân công'}"></span>
                            </div>
                        </div>

                        <div class="mb-3 row">
                            <label class="col-sm-5 col-form-label"><strong>Ngày bắt đầu:</strong></label>
                            <div class="col-sm-7">
                                <span th:text="${Incident.startDate != null ? #dates.format(Incident.startDate, 'dd/MM/yyyy HH:mm') : 'Chưa có'}"></span>
                            </div>
                        </div>

                        <div class="mb-3 row">
                            <label class="col-sm-5 col-form-label"><strong>Ngày kết thúc dự kiến:</strong></label>
                            <div class="col-sm-7">
                                <span th:text="${Incident.endDate != null ? #dates.format(Incident.endDate, 'dd/MM/yyyy HH:mm') : 'Chưa có'}"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-12 mt-2" th:if="${Incident.status == 'RESOLVED'}">
                <div class="text-end">
                    <a th:href="@{|/admin/incident-manager/${Incident.id}/detail-repair|}" class="btn btn-outline-primary">
                        Xem chi tiết sửa chữa
                    </a>
                </div>
            </div>
        </div>
    </main>

    <div th:replace="base :: footer"></div>

    <script>
        function toggleEmployeeDropdown(value) {
            const empFields = document.getElementById('approvedFields');
            empFields.style.display = (value === 'APPROVED') ? 'block' : 'none';
        }

        document.addEventListener("DOMContentLoaded", function () {
            const statusElement = document.getElementById('status');
            if (statusElement)
                toggleEmployeeDropdown(statusElement.value);
        });

        function validateForm() {
            const status = document.getElementById('status').value;
            if (status === 'APPROVED') {
                const employeeId = document.getElementById('employeeId').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                if (!employeeId || !startDate || !endDate) {
                    alert('Khi chọn APPROVED, bạn phải chọn nhân viên và nhập ngày bắt đầu, ngày kết thúc!');
                    return false;
                }

                const now = new Date();
                const sDate = new Date(startDate);
                const eDate = new Date(endDate);

                if (sDate >= eDate) {
                    alert('Ngày bắt đầu phải trước ngày kết thúc!');
                    return false;
                }

                if (sDate < now) {
                    alert('Ngày bắt đầu không được là quá khứ!');
                    return false;
                }
            }
            return true;
        }
    </script>
</body>
</html>
