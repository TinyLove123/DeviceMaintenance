<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Quản lý sự cố</title>
    <th:block th:replace="base :: bootstrap"></th:block>
</head>
<body>
    <div th:replace="base :: header"></div>

    <div class="container mt-4">
        <h2>Quản lý báo cáo sự cố</h2>

        <!-- Form lọc theo trạng thái -->
        <form method="get" th:action="@{/admin/incident-manager}" class="mb-3">
            <div class="row">
                <div class="col-md-4">
                    <select name="status" class="form-select" onchange="this.form.submit()">
                        <option value="">-- Tất cả trạng thái --</option>
                        <option value="PENDING_APPROVAL">Chờ duyệt</option>
                        <option value="APPROVED">Đã duyệt</option>
                        <option value="IN_PROGRESS">Đang xử lý</option>
                        <option value="RESOLVED">Đã hoàn thành</option>
                        <option value="REJECTED">Từ chối</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary">Lọc</button>
                </div>
            </div>
        </form>

        <!-- Bảng danh sách sự cố -->
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tiêu đề</th>
                    <th>Mô tả</th>
                    <th>Trạng thái nhận</th>
                    <th>Thiết bị</th>
                    <th>Trạng thái</th>
                    <th>Người gửi</th>
                    <th>Ngày gửi</th>
                    <th>Người duyệt</th>
                    <th>Ngày duyệt</th>     
                    <th>Ngày thực hiện</th>
                    <th>Ngày kết thúc</th>
                    <th>Khẩn cấp</th>
                    <td>Hành động</td>
                </tr>
            </thead>
            <tbody>
                <tr th:each="incident : ${Incidents}">
                    <td th:text="${incident.id}"></td>
                    <td th:text="${incident.title}"></td>
                    <td th:text="${incident.detailDescribe}"></td>
                    <td th:text="${incident.receptStatus!=null? incident.receptStatus:'Chưa cập nhật'}"></td>
                    <td th:text="${incident.deviceId != null ? incident.deviceId.nameDevice : 'N/A'}"></td>
                    <td th:text="${incident.status}"></td>
                    <td th:text="${incident.senderId != null ? incident.senderId.firstName + ' ' + incident.senderId.lastName : 'N/A'}"></td>
                    <td th:text="${#dates.format(incident.reportDate, 'yyyy-MM-dd HH:mm:ss')}"></td>
                    <td th:text="${incident.employeeId != null ? incident.employeeId.firstName + ' ' + incident.employeeId.lastName : 'Chưa cập nhật'}"></td>
                    <td th:text="${incident.approvalDate != null ? #dates.format(incident.approvalDate, 'yyyy-MM-dd HH:mm:ss') : ''}"></td>
                    <td th:text="${incident.startDate != null ? #dates.format(incident.startDate, 'yyyy-MM-dd HH:mm:ss') : ''}"></td>
                    <td th:text="${incident.endDate != null ? #dates.format(incident.endDate, 'yyyy-MM-dd HH:mm:ss') : ''}"></td>
                    <td>
                        <span th:if="${incident.isEmergency == true}" class="badge bg-danger">Khẩn</span>
                        <span th:if="${incident.isEmergency != true}" class="badge bg-secondary">Bình thường</span>
                    </td>
                    <td>
                        <a th:href="@{/admin/incident-manager/{id}/incident-detail(id=${incident.id})}" class="btn btn-primary mb-1">Xem thêm</a>

                        <!-- Nếu trạng thái là APPROVED thì hiện nút gửi mail -->
                        <button type="button" class="btn btn-warning"
                                th:if="${incident.status == 'APPROVED'}"
                                th:attr="onclick=|sendIncidentMail(${incident.id})|">
                            Gửi mail
                        </button>

                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <script>
        function sendIncidentMail(incidentId) {
            const contextPath = window.location.pathname.split('/')[1]; // Lấy context path
            const url = `/${contextPath}/admin/send-incident-mail/${incidentId}/incident`;
            fetch(url, {
                method: 'POST'
            })
                    .then(res => {
                        if (!res.ok) {
                            throw new Error("Gửi thất bại");
                        }
                        return res.text();
                    })
                    .then(message => {
                        alert(message); // ✅ Gửi thành công
                    })
                    .catch(err => {
                        alert("Lỗi khi gửi mail: " + err.message);
                    });
        }
    </script>

    <div th:replace="base :: footer"></div>
</body>
</html>
