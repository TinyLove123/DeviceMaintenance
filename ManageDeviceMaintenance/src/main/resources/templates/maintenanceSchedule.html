<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>LỊCH BẢO TRÌ</title>
    <th:block th:replace="base :: bootstrap"></th:block>


</head>
<body>
    <div th:replace="base :: header"></div>

    <main class="container my-4">

        <form method="get" th:action="@{/admin/maintenance-schedule-manager}" class="mb-3">
            <div class="row g-2">
                <div class="col-auto">
                    <label for="progress" class="form-label">Lọc theo tiến trình:</label>
                    <select name="progress" id="progress">
                        <option value="in_completed" th:selected="${params.progress == 'in_completed'}">Chưa thực hiện</option>
                        <option value="in_progress" th:selected="${params.progress == 'in_progress'}">Đang thực hiện</option>
                        <option value="completed" th:selected="${params.progress == 'completed'}">Hoàn thành</option>
                    </select>
                    <button type="submit">Lọc</button>                
                </div>
            </div>
        </form>


        <a 
            th:href="@{/admin/maintenance-schedule-manager/add-maintenance-schedule}"
            class="btn btn-primary">Thêm lịch bảo trì</a> 



        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Ngày bắt đầu</th>
                    <th>Tiến trình</th>
                    <th>Thiết bị</th>
                    <th>Trạng thái thiết bị</th>
                    <th>Nhân viên</th>
                    <th>Tình trạng</th>
                    <th>Cập nhật</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="m : ${maintenanceSchedules}">
                    <td th:text="${m.startDate}"></td>
                    <td th:text="
                        ${m.progress == 'in_progress'} ? 'Đang thực hiện' :
                        (${m.progress == 'completed'} ? 'Hoàn thành' :
                        (${m.progress == 'in_completed'} ? 'Chưa xử lý' : 'Không xác định'))"
                        th:classappend="
                        ${m.progress == 'in_progress'} ? 'text-warning fw-bold bg-light' :
                        (${m.progress == 'completed'} ? 'text-success fw-bold bg-light' :
                        (${m.progress == 'in_completed'} ? 'text-danger fw-bold bg-light' : 'text-dark fw-bold bg-light'))">
                    </td>
                    <td th:text="${m.deviceId.nameDevice}"></td>
                    <td th:text="${m.progress == 'completed'} ? '--' : ${m.deviceId.statusDevice}"></td>
                    <td th:text="${m.employeeId != null ? m.employeeId.firstName + ' ' + m.employeeId.lastName : 'Chưa xếp'}"
                        th:classappend="${m.employeeId == null} ? 'text-danger fw-bold' : ''"></td>

                    <td>
                        <span th:if="${m.progress != 'completed'}" th:attr="data-start=${m.startDate}" class="remaining-days"></span>
                    </td>
                    <td>
                        <div th:if="${m.progress == 'in_completed'}">
                            <a th:href="@{/admin/maintenance-schedule-manager/{id}/maintenance-schedule-detail(id=${m.id})}"
                               class="btn btn-primary">Chỉnh sửa</a>

                            <form th:action="@{/admin/maintenance-schedule-manager/delete}" 
                                  method="post" 
                                  style="display:inline"
                                  onsubmit="return confirm('Bạn có chắc chắn muốn xóa lịch bảo trì này không?');">

                                <input type="hidden" name="id" th:value="${m.id}" />
                                <button type="submit" class="btn btn-danger ms-2">Xóa</button>
                            </form>                        </div>
                    </td>

                </tr>
            </tbody>
        </table>
    </main>

    <div th:replace="base :: footer"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const rows = document.querySelectorAll('.remaining-days');
            const now = new Date();

            rows.forEach(span => {
                const startDateStr = span.getAttribute('data-start');
                const startDate = new Date(startDateStr);
                const diffTime = startDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays > 0) {
                    span.textContent = `Còn ${diffDays} ngày`;
                    span.classList.add('text-success', 'fw-bold');
                } else {
                    span.textContent = `Quá hạn ${-diffDays} ngày`;
                    span.classList.add('text-danger', 'fw-bold');
                }
            });
        });
    </script>
</body>
</html>
