<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Trang chủ</title>
    <th:block th:replace="base :: bootstrap"></th:block>
</head>
<body>
    <div th:replace="base :: header"></div>

    <main class="container mt-4">
        <h2 class="mb-4">Tổng quan hệ thống</h2>

        <!-- Sự cố phát sinh hôm nay -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark fw-bold">
                Sự cố phát sinh hôm nay
            </div>
            <div class="card-body">
                <h5 class="card-title">Tổng cộng: <span th:text="${incidentCountToday}">0</span> sự cố</h5>
            </div>
        </div>

        <!-- Danh sách sự cố chưa duyệt -->
        <div class="card mb-4">
            <div class="card-header bg-danger text-white fw-bold">
                Danh sách sự cố chưa duyệt
            </div>
            <div class="card-body">
                <table class="table table-bordered table-striped">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Tiêu đề</th>
                            <th>Thiết bị</th>
                            <th>Người gửi</th>
                            <th>Khẩn cấp</th>
                            <th>Ngày gửi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="i, stat : ${unapprovedIncidents}">
                            <td th:text="${stat.count}"></td>
                            <td th:text="${i.title}"></td>
                            <td th:text="${i.deviceId.nameDevice}"></td>
                            <td th:text="${i.senderId.lastName + ' ' + i.senderId.firstName}"></td>
                            <td>
                                <span th:if="${i.isEmergency}" class="badge bg-danger">Khẩn</span>
                                <span th:unless="${i.isEmergency}" class="badge bg-secondary">Thường</span>
                            </td>
                            <td th:text="${#dates.format(i.reportDate, 'dd/MM/yyyy HH:mm')}"></td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(unapprovedIncidents)}">
                            <td colspan="6" class="text-center text-muted">Không có sự cố nào chưa duyệt</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Lịch bảo trì hôm nay -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white fw-bold">
                Thiết bị cần bảo trì hôm nay
            </div>
            <div class="card-body">
                <table class="table table-bordered table-striped">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Tên thiết bị</th>
                            <th>Vị trí</th>
                            <th>Thời gian dự kiến</th>
                            <th>Tình trạng</th>
                            <th>Nhân viên</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="m, stat : ${maintenanceSchedules}">
                            <td th:text="${stat.count}"></td>
                            <td th:text="${m.deviceId.nameDevice}"></td>
                            <td><span th:text="${m.deviceId.currentLocationId != null ? m.deviceId.currentLocationId.wardId.fullName
                                      + ', ' + m.deviceId.currentLocationId.wardId.provinceCode.fullName 
                                      + ', ' + m.deviceId.currentLocationId.address : 'Chưa cập nhật'}"></span>
                            <td>
                                <span th:text="${#dates.format(m.startDate, 'dd/MM/yyyy')}"></span>
                            </td>
                            <td>
                                <span th:attr="data-start=${m.startDate}" class="remaining-days"></span>
                            </td>
                            <td th:text="${m.employeeId != null ? m.employeeId.lastName + ' ' + m.employeeId.firstName : 'Chưa phân công'}"></td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(maintenanceSchedules)}">
                            <td colspan="5" class="text-center text-muted">Không có lịch bảo trì hôm nay</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div th:replace="base :: footer"></div>
    <script>


        document.addEventListener('DOMContentLoaded', function () {
            const rows = document.querySelectorAll('.remaining-days');
            const now = new Date();

            rows.forEach(span => {
                const startDateStr = span.getAttribute('data-start');
                const startDate = new Date(startDateStr);
                const diffTime = startDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays > 0) {
                    span.textContent = `Còn ${diffDays} ngày`;
                    span.classList.add('text-success', 'fw-bold');
                } else {
                    span.textContent = `Quá hạn ${-diffDays} ngày`;
                    span.classList.add('text-danger', 'fw-bold');
                }
            });
        });
    </script>
</body>
</html>
